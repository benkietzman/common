// vim: syntax=cpp
// vim600: fdm=marker
/* -*- c++ -*- */
///////////////////////////////////////////
// Radial
// -------------------------------------
// file       : Radial
// author     : Ben Kietzman
// begin      : 2022-07-27
// copyright  : kietzman.org
// email      : ben@kietzman.org
///////////////////////////////////////////

/**************************************************************************
*                                                                         *
*   This program is free software; you can redistribute it and/or modify  *
*   it under the terms of the GNU General Public License as published by  *
*   the Free Software Foundation; either version 2 of the License, or     *
*   (at your option) any later version.                                   *
*                                                                         *
**************************************************************************/

/*! \file Radial
* \brief Radial Class
*/
#ifndef _COMMON_RADIAL_
#define _COMMON_RADIAL_
// {{{ includes
#include <fcntl.h>
#include <fstream>
#include <iostream>
#include <list>
#include <mutex>
#include <netdb.h>
#include <openssl/err.h>
#include <openssl/ssl.h>
#include <poll.h>
#include <pthread.h>
#ifdef COMMON_LINUX
#include <semaphore.h>
#endif
#include <string>
#ifdef COMMON_SOLARIS
#include <synch.h>
#endif
#include <sys/socket.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <thread>
#include <vector>
using namespace std;
#include "Json"
#include "StringManip"
#include "Utility"
// }}}
extern "C++"
{
  namespace common
  {
    // {{{ radialreqdata
    struct radialreqdata
    {
      bool bSent;
      int fdSocket;
      string strBuffer[2];
    };
    // }}}
    // {{{ radialTerminalInfo
    struct radialTerminalInfo
    {
      size_t unCol;
      size_t unCols;
      size_t unRow;
      size_t unRows;
      string strSession;
      vector<string> screen;
    };
    // }}}
    // {{{ Radial
    //! Interfaces with Radial.
    /*!
    * Provides an interface to Radial.
    */
    class Radial
    {
      protected:
      bool m_bUseSingleSocket;
      map<int, radialreqdata *> m_requests;
      size_t m_unThrottle;
      size_t m_unUniqueID;
      std::mutex m_mutexGetAddrInfo;
      std::mutex m_mutexRequests;
      std::mutex m_mutexUnique;
      string m_strPassword;
      string m_strServer;
      string m_strTimeout;
      string m_strUser;
      string m_strUserID;
      thread *m_pThreadRequest;
      time_t m_ulModifyTime;
      StringManip m_manip;
      Utility *m_pUtility;

      bool terminalRequest(radialTerminalInfo &tInfo, const string strFunction, string &strError);
      bool terminalRequest(radialTerminalInfo &tInfo, const string strFunction, map<string, string> data, string &strError);
      bool terminalRequest(radialTerminalInfo &tInfo, const string strFunction, map<string, string> data, Json *ptJson, string &strError);

      public:
      Radial(string &strError);
      ~Radial();

      bool alert(const string strUser, const string strMessage, string &strError);
      void databaseFree(list<map<string, string> > *result);
      list<map<string, string> > *databaseQuery(const string strDatabase, const string strQuery, string &strError);
      list<map<string, string> > *databaseQuery(const string strDatabase, const string strQuery, unsigned long long &ullRows, string &strError);
      bool databaseUpdate(const string strDatabase, const string strUpdate, string &strError);
      bool databaseUpdate(const string strDatabase, const string strUpdate, unsigned long long &ullID, unsigned long long &ullRows, string &strError);
      void dbFree(list<map<string, string> > *result);
      list<map<string, string> > *dbQuery(const string strDatabase, const string strQuery, string &strError);
      list<map<string, string> > *dbQuery(const string strDatabase, const string strQuery, unsigned long long &ullRows, string &strError);
      bool dbUpdate(const string strDatabase, const string strUpdate, string &strError);
      bool dbUpdate(const string strDatabase, const string strUpdate, unsigned long long &ullID, unsigned long long &ullRows, string &strError);
      bool hubList(map<string, map<string, string> > &interfaces, string &strError);
      bool hubPing(string &strError);
      bool ircChat(const string strTarget, const string strMessage, string &strError);
      bool linkStatus(list<string> &nodes, string &strMaster, string &strError);
      bool mysqlQuery(const string strUser, const string strPassword, const string strServer, const string strDatabase, const string strQuery, list<map<string, string> > &result, string &strError);
      bool mysqlUpdate(const string strUser, const string strPassword, const string strServer, const string strDatabase, const string strUpdate, string &strID, string &strRows, string &strError);
      bool mysqlUpdate(const string strUser, const string strPassword, const string strServer, const string strDatabase, const string strUpdate, string &strError);
      bool request(Json *ptRequest, Json *ptResponse, string &strError);
      bool request(Json *ptRequest, Json *ptResponse, time_t CTimeout, string &strError);
      void requestThread();
      void setCredentials(const string strUser, const string strPassword, const string strUserID = "");
      void setServer(const string strServer);
      void setThrottle(const size_t unThrottle);
      void setTimeout(const string strTimeout);
      bool sshConnect(const string strServer, const string strPort, const string strUser, const string strPassword, string &strSession, string &strData, string &strError);
      bool sshDisconnect(string &strSession, string &strError);
      bool sshSend(string &strSession, const string strCommand, string &strData, string &strError);
      bool storageAdd(list<string> keys, Json *ptData, string &strError);
      bool storageRemove(list<string> keys, string &strError);
      bool storageRetrieve(list<string> keys, Json *ptData, string &strError);
      bool storageRetrieveKeys(list<string> inKeys, list<string> &outKeys, string &strError);
      bool storageUpdate(list<string> keys, Json *ptData, string &strError);
      bool terminalConnect(radialTerminalInfo &tInfo, const string strServer, const string strPort, const bool bWait, string &strError);
      bool terminalDisconnect(radialTerminalInfo &tInfo, string &strError);
      bool terminalGetSocketTimeout(radialTerminalInfo &tInfo, int &nShort, int &nLong, string &strError);
      bool terminalScreen(radialTerminalInfo &tInfo, string &strError);
      bool terminalSend(radialTerminalInfo &tInfo, const string strData, const size_t unCount, const bool bWait, string &strError);
      bool terminalSendCtrl(radialTerminalInfo &tInfo, const char cData, const bool bWait, string &strError);
      bool terminalSendDown(radialTerminalInfo &tInfo, const size_t unCount, const bool bWait, string &strError);
      bool terminalSendEnter(radialTerminalInfo &tInfo, const bool bWait, string &strError);
      bool terminalSendEscape(radialTerminalInfo &tInfo, const bool bWait, string &strError);
      bool terminalSendFunction(radialTerminalInfo &tInfo, const int nKey, string &strError);
      bool terminalSendHome(radialTerminalInfo &tInfo, const bool bWait, string &strError);
      bool terminalSendKey(radialTerminalInfo &tInfo, const char cData, const size_t unCount, const bool bWait, string &strError);
      bool terminalSendKeypadEnter(radialTerminalInfo &tInfo, const bool bWait, string &strError);
      bool terminalSendLeft(radialTerminalInfo &tInfo, const size_t unCount, const bool bWait, string &strError);
      bool terminalSendRight(radialTerminalInfo &tInfo, const size_t unCount, const bool bWait, string &strError);
      bool terminalSendShiftFunction(radialTerminalInfo &tInfo, const int nKey, string &strError);
      bool terminalSendTab(radialTerminalInfo &tInfo, const size_t unCount, const bool bWait, string &strError);
      bool terminalSendUp(radialTerminalInfo &tInfo, const size_t unCount, const bool bWait, string &strError);
      bool terminalSetSocketTimeout(radialTerminalInfo &tInfo, const int nShort, const int nLong, string &strError);
      bool terminalWait(radialTerminalInfo &tInfo, const bool bWait, string &strError);
      void useSingleSocket(const bool bUseSingleSocket = true);
      Utility *utility();
    };
    // }}}
  }
}
#endif
